<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEURAL TEN: OVERCLOCK</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0ff;
            --secondary: #f0f;
            --bg: #050510;
            --surface: rgba(20, 30, 40, 0.8);
            --success: #0f0;
            --error: #f00;
        }

        * { box-sizing: border-box; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            color: var(--primary);
            font-family: 'Share Tech Mono', monospace;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* CRT Effect */
        body::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 999;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        /* Layouts */
        .screen {
            display: none;
            width: 100%; height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            z-index: 10;
            transition: opacity 0.3s;
        }
        .active { display: flex; }

        h1 { font-family: 'Orbitron'; font-size: 2.5rem; text-shadow: 0 0 10px var(--primary); margin: 0 0 10px 0; text-align: center;}
        
        /* Login */
        input.cyber-input {
            background: rgba(0,0,0,0.7);
            border: 1px solid var(--primary);
            color: #fff;
            padding: 15px;
            font-size: 1.5rem;
            font-family: 'Orbitron';
            text-align: center;
            width: 80%; max-width: 300px;
            margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
        }

        button.cyber-btn {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 15px 40px;
            font-size: 1.2rem;
            font-family: 'Orbitron';
            cursor: pointer;
            transition: 0.2s;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
        }
        button.cyber-btn:hover { background: rgba(0, 255, 255, 0.1); box-shadow: 0 0 20px var(--primary); }
        button.cyber-btn:active { background: var(--primary); color: #000; }

        /* Game UI */
        .hud {
            width: 100%; max-width: 600px;
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 10px; border-bottom: 1px solid rgba(0,255,255,0.3);
            margin-bottom: 10px;
        }
        .timer { font-size: 2.5rem; color: var(--secondary); font-family: 'Orbitron'; text-shadow: 0 0 10px var(--secondary); }
        .target-display { font-size: 1rem; text-align: right; opacity: 0.8; }

        .formula-box {
            width: 95%; max-width: 600px;
            height: 60px;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--primary);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem;
            margin-bottom: 10px;
            position: relative;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }
        .formula-box.error { animation: shake 0.3s ease-in-out; border-color: var(--error); color: var(--error); }
        .formula-box.success { border-color: var(--success); color: var(--success); box-shadow: inset 0 0 20px var(--success); }

        /* The Field (Cards) */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            width: 95%; max-width: 500px;
            margin-bottom: 10px;
        }
        .card {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem;
            font-family: 'Orbitron';
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            position: relative;
        }
        .card:active { transform: scale(0.95); }
        .card.selected { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); border-color: #fff; }
        .card.hidden { visibility: hidden; pointer-events: none; }

        /* Controllers */
        .controls { width: 95%; max-width: 600px; }
        .basic-ops { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-bottom: 5px; }
        .op-btn {
            background: rgba(0,0,0,0.3); border: 1px solid #444; color: #ccc;
            padding: 12px 0; text-align: center; font-size: 1.2rem; cursor: pointer;
        }
        .op-btn:active { background: #333; color: #fff; border-color: #fff; }

        .adv-drawer {
            max-height: 0; overflow: hidden; transition: max-height 0.3s;
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px;
            margin-bottom: 5px;
        }
        .adv-drawer.open { max-height: 100px; }
        .adv-btn { border-color: var(--secondary); color: var(--secondary); font-size: 1rem; }
        
        .action-row { display: flex; gap: 10px; margin-top: 5px; height: 50px; }
        .act-btn { flex: 1; font-family: 'Orbitron'; font-weight: bold; font-size: 1.2rem; cursor: pointer; border: none; }
        #btn-clear { background: #333; color: #fff; border: 1px solid #555; }
        #btn-exe { background: var(--primary); color: #000; border: 1px solid #fff; box-shadow: 0 0 10px var(--primary); }
        
        /* Ranking */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #333; }
        th { color: var(--secondary); }
        .rank-1 { color: #ffd700; text-shadow: 0 0 5px #ffd700; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <h1>NEURAL<span style="color:var(--secondary)">TEN</span></h1>
        <p style="opacity: 0.7; margin-bottom: 30px;">OVERCLOCK // PROTOCOL</p>
        
        <input type="text" id="username" class="cyber-input" placeholder="AGENT NAME" maxlength="12">
        <button class="cyber-btn" onclick="app.login()">INITIALIZE LINK</button>
        
        <div style="margin-top: 40px; font-size: 0.8rem; color: #666; max-width: 300px; text-align: center;">
            MISSION: Clear all cards by creating formulas equal to 10.<br>
            SPEED is crucial. INTELLIGENCE is rewarded.
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="hud">
            <div id="timer" class="timer">00:00:00</div>
            <div class="target-display">
                TARGET: <span style="color:var(--primary); font-size: 1.5rem; font-weight:bold;">10</span><br>
                CARDS: <span id="card-count">16</span>
            </div>
        </div>

        <div id="formula-display" class="formula-box"></div>

        <div id="grid" class="grid-container">
            </div>

        <div class="controls">
            <div class="basic-ops">
                <div class="op-btn" onclick="game.addOp('+')">+</div>
                <div class="op-btn" onclick="game.addOp('-')">-</div>
                <div class="op-btn" onclick="game.addOp('*')">×</div>
                <div class="op-btn" onclick="game.addOp('/')">÷</div>
                <div class="op-btn" onclick="game.addOp('(')">(</div>
                <div class="op-btn" onclick="game.addOp(')')">)</div>
            </div>

            <div style="text-align: center; margin-bottom: 5px;">
                <span onclick="game.toggleAdv()" style="font-size: 0.7rem; cursor: pointer; border-bottom: 1px dashed #666;">▼ ADVANCED MODULES ▼</span>
            </div>
            
            <div id="adv-panel" class="adv-drawer">
                <div class="op-btn adv-btn" onclick="game.addFunc('Math.sqrt(')">√</div>
                <div class="op-btn adv-btn" onclick="game.addFunc('Math.floor(')">FLR</div>
                <div class="op-btn adv-btn" onclick="game.addOp('**')">POW</div>
                <div class="op-btn adv-btn" onclick="game.useWild()" style="color:#fff; border-color:#fff;">WILD</div>
            </div>

            <div class="action-row">
                <button id="btn-clear" class="act-btn" onclick="game.resetInput()">CLEAR</button>
                <button id="btn-exe" class="act-btn" onclick="game.execute()">EXECUTE</button>
            </div>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <h1 style="color: var(--secondary)">COMPLETED</h1>
        <div style="font-size: 4rem; color: #fff; margin: 10px 0;" id="final-score">0</div>
        <div id="final-stats" style="color: #aaa; margin-bottom: 20px;"></div>
        
        <h3 style="border-bottom: 1px solid var(--primary); padding-bottom: 5px; width: 100%;">GLOBAL ELITE</h3>
        <div id="ranking-container" style="width: 100%;">LOADING...</div>
        
        <button class="cyber-btn" style="margin-top: 30px;" onclick="location.reload()">RE-ENGAGE</button>
    </div>

    <script>
        const audioSys = {
            ctx: null,
            init: function() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
            },
            play: function(type) {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);

                const now = this.ctx.currentTime;
                if(type === 'click') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                } else if(type === 'success') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.setValueAtTime(880, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                } else if(type === 'error') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.2);
                    osc.start(now);
                    osc.stop(now + 0.2);
                }
            }
        };
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCrhya7vth8ecxzd7TZA7jQIwYrKsZq7_0",
            authDomain: "make10speed.firebaseapp.com",
            projectId: "make10speed",
            storageBucket: "make10speed.firebasestorage.app",
            messagingSenderId: "422015463278",
            appId: "1:422015463278:web:df7d98641c2adf6d915b7f",
            measurementId: "G-7XLB8CVG6D"
        };

        const fApp = initializeApp(firebaseConfig);
        const db = getFirestore(fApp);

        // --- GLOBAL STATE ---
        const state = {
            user: { name: "GUEST", uid: null },
            cards: [], // {id, val, active}
            deckSize: 16,
            formula: [], // Items: {type: 'num'|'op'|'func', val: '...', refId: null}
            startTime: 0,
            timer: null,
            advUsed: 0,
            wildUsed: 0,
            isPlaying: false
        };

        // --- APP CONTROLLER ---
        window.app = {
            login: () => {
                const input = document.getElementById('username').value.trim();
                if(!input) return alert("CODENAME REQUIRED");
                
                state.user.name = input;
                // Generate/Retrieve Persistent ID
                let uid = localStorage.getItem('nt_uid');
                if(!uid) {
                    uid = 'USR-' + Date.now().toString(36) + Math.random().toString(36).substr(2,5);
                    localStorage.setItem('nt_uid', uid);
                }
                state.user.uid = uid;

                audioSys.init(); // Init Audio Context on user interaction
                audioSys.play('success');

                document.getElementById('screen-login').classList.remove('active');
                document.getElementById('screen-game').classList.add('active');
                game.init();
            }
        };

        // --- GAME CONTROLLER ---
        window.game = {
            init: () => {
                // Generate Deck (Ensure solvable-ish, but for Speed/Puzzle, random is fine)
                state.cards = [];
                for(let i=0; i<state.deckSize; i++) {
                    state.cards.push({
                        id: i,
                        val: Math.floor(Math.random() * 9) + 1,
                        active: true
                    });
                }
                state.formula = [];
                state.advUsed = 0;
                state.wildUsed = 0;
                state.startTime = Date.now();
                state.isPlaying = true;
                
                this.renderGrid();
                this.updateDisplay();
                
                if(state.timer) clearInterval(state.timer);
                state.timer = setInterval(this.tick, 30);
            },

            tick: () => {
                if(!state.isPlaying) return;
                const now = Date.now();
                const diff = now - state.startTime;
                
                const m = Math.floor(diff / 60000).toString().padStart(2,'0');
                const s = Math.floor((diff % 60000) / 1000).toString().padStart(2,'0');
                const ms = Math.floor((diff % 1000) / 10).toString().padStart(2,'0');
                
                document.getElementById('timer').innerText = `${m}:${s}:${ms}`;
            },

            renderGrid: () => {
                const grid = document.getElementById('grid');
                grid.innerHTML = '';
                state.cards.forEach(c => {
                    const el = document.createElement('div');
                    el.className = `card ${c.active ? '' : 'hidden'}`;
                    // Check if selected in current formula
                    const isSelected = state.formula.some(item => item.refId === c.id);
                    if(isSelected) el.classList.add('selected');
                    
                    el.innerText = c.val;
                    el.onclick = () => this.selectCard(c.id);
                    grid.appendChild(el);
                });
                
                // Count remaining
                const remaining = state.cards.filter(c => c.active).length;
                document.getElementById('card-count').innerText = remaining;
                
                if(remaining === 0) this.win();
            },

            selectCard: (id) => {
                const card = state.cards.find(c => c.id === id);
                if(!card.active) return;
                
                // Toggle logic: If already last in formula, remove it. If not in, add it.
                // Simplified for speed: Always add unless it's already used in current formula
                if(state.formula.some(item => item.refId === id)) return; // Already selected

                state.formula.push({ type: 'num', val: card.val, refId: id });
                audioSys.play('click');
                this.renderGrid();
                this.updateDisplay();
            },

            addOp: (op) => {
                state.formula.push({ type: 'op', val: op, refId: null });
                audioSys.play('click');
                this.updateDisplay();
            },

            addFunc: (func) => {
                state.formula.push({ type: 'func', val: func, refId: null });
                state.advUsed++;
                audioSys.play('click');
                this.updateDisplay();
            },

            useWild: () => {
                const val = prompt("ENTER VALUE (0-9):");
                const num = parseInt(val);
                if(!isNaN(num)) {
                    state.formula.push({ type: 'wild', val: num, refId: 'WILD' });
                    state.wildUsed++;
                    this.updateDisplay();
                }
            },

            toggleAdv: () => {
                document.getElementById('adv-panel').classList.toggle('open');
            },

            resetInput: () => {
                state.formula = [];
                audioSys.play('error');
                this.renderGrid(); // Clears selection visuals
                this.updateDisplay();
            },

            updateDisplay: () => {
                const box = document.getElementById('formula-display');
                // Convert formula array to string for display
                const str = state.formula.map(i => i.val).join(' ');
                box.innerText = str;
                box.classList.remove('error', 'success');
            },

            execute: () => {
                if(state.formula.length === 0) return;

                // 1. Build String
                let expr = state.formula.map(item => item.val).join('');
                
                // 2. Evaluate
                try {
                    // Safety sanitize (tho only internal input allowed)
                    // Using Function constructor to eval math
                    const res = Function('"use strict";return (' + expr + ')')();
                    
                    // 3. Check 10
                    if(Math.abs(res - 10) < 0.000001) {
                        // SUCCESS
                        audioSys.play('success');
                        document.getElementById('formula-display').classList.add('success');
                        
                        // Mark cards as inactive
                        state.formula.forEach(item => {
                            if(item.refId && item.refId !== 'WILD') {
                                const c = state.cards.find(c => c.id === item.refId);
                                if(c) c.active = false;
                            }
                        });
                        
                        state.formula = [];
                        setTimeout(() => {
                            this.renderGrid();
                            this.updateDisplay();
                        }, 200);

                    } else {
                        // WRONG NUMBER
                        throw new Error("Not 10");
                    }
                } catch(e) {
                    // ERROR
                    audioSys.play('error');
                    const box = document.getElementById('formula-display');
                    box.classList.add('error');
                    // Optional: auto clear? Let's leave it for user to fix
                }
            },

            win: async () => {
                state.isPlaying = false;
                clearInterval(state.timer);
                
                const timeMs = Date.now() - state.startTime;
                
                // Calc Score
                // Base: 500,000
                // Time Penalty: -1 per ms
                // Bonus: Adv Math (+2000 each)
                // Penalty: Wild (-5000 each)
                let score = 500000 - timeMs + (state.advUsed * 2000) - (state.wildUsed * 5000);
                if(score < 0) score = 0;

                // Show Result
                document.getElementById('screen-game').classList.remove('active');
                document.getElementById('screen-result').classList.add('active');
                
                document.getElementById('final-score').innerText = score.toLocaleString();
                document.getElementById('final-stats').innerHTML = 
                    `TIME: ${(timeMs/1000).toFixed(2)}s | ADV BONUS: ${state.advUsed} | WILD PENALTY: ${state.wildUsed}`;

                // Save to DB
                try {
                    await addDoc(collection(db, "scores"), {
                        name: state.user.name,
                        uid: state.user.uid,
                        score: score,
                        time: timeMs,
                        createdAt: new Date()
                    });
                    this.loadRanking();
                } catch(e) {
                    console.error("Save failed", e);
                    document.getElementById('ranking-container').innerText = "NETWORK ERROR - SCORE SAVED LOCALLY";
                }
            },

            loadRanking: async () => {
                const container = document.getElementById('ranking-container');
                try {
                    const q = query(collection(db, "scores"), orderBy("score", "desc"), limit(7));
                    const snapshot = await getDocs(q);
                    
                    let html = '<table><tr><th>#</th><th>AGENT</th><th>SCORE</th></tr>';
                    let rank = 1;
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        const isMe = d.uid === state.user.uid;
                        const rowClass = rank === 1 ? 'rank-1' : '';
                        const nameDisplay = isMe ? `${d.name} <span style="font-size:0.7em;color:var(--primary)">[YOU]</span>` : d.name;
                        
                        html += `<tr class="${rowClass}"><td>${rank}</td><td>${nameDisplay}</td><td>${d.score.toLocaleString()}</td></tr>`;
                        rank++;
                    });
                    html += '</table>';
                    container.innerHTML = html;
                } catch(e) {
                    container.innerText = "DATA UPLINK FAILED";
                }
            }
        };
    </script>
</body>
</html>
