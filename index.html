<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Make10: Clean</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg: #F5F5F7;
            --surface: #FFFFFF;
            --text: #1d1d1f;
            --sub-text: #86868b;
            --accent: #0071e3;
            --border: #d2d2d7;
            --danger: #ff3b30;
            --success: #34c759;
            --prime: #af52de;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * { box-sizing: border-box; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg); color: var(--text); font-family: var(--font);
            margin: 0; padding: 0; 
            /* „Çπ„Éû„Éõ„ÅÆ„Ç¢„Éâ„É¨„Çπ„Éê„ÉºÂØæÁ≠ñ: dvh„Çí‰ΩøÁî® */
            height: 100vh; height: 100dvh; 
            overflow: hidden;
            display: flex; justify-content: center;
        }

        #app {
            width: 100%; max-width: 500px; height: 100%; position: relative;
            background: var(--surface); display: flex; flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }
        /* PCÁ≠â„ÅÆÂ§ßÁîªÈù¢ÊôÇ„ÅÆ„ÅøÊû†„ÇíË°®Á§∫ */
        @media(min-width: 500px) { 
            #app { height: 95vh; margin-top: 2.5vh; border-radius: 18px; border: 1px solid #e5e5ea; overflow: hidden; } 
        }

        .screen {
            position: absolute; inset: 0; 
            /* „Çπ„Éû„ÉõÁî®„Å´„Éë„Éá„Ç£„É≥„Ç∞„ÇíÂ∞ë„ÅóÁ∏ÆÂ∞è */
            padding: 16px; 
            display: flex; flex-direction: column;
            background: var(--surface); opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .screen.active { opacity: 1; pointer-events: auto; z-index: 10; }

        h1 { font-size: 22px; font-weight: 600; margin-bottom: 8px; text-align: center; }
        .label { font-size: 11px; font-weight: 600; color: var(--sub-text); margin-bottom: 4px; display: block; }
        
        .rule-container { margin-bottom: 20px; }
        .rule-desc { text-align: center; color: var(--sub-text); font-size: 12px; line-height: 1.4; margin-bottom: 10px; }
        
        details {
            font-size: 11px; color: var(--sub-text); text-align: left;
            background: #f9f9f9; padding: 8px; border-radius: 8px; border: 1px solid #eee;
        }
        summary { cursor: pointer; font-weight: 600; color: var(--accent); outline: none; margin-bottom: 2px; }
        .rule-list { margin: 4px 0 0 16px; padding: 0; line-height: 1.5; }
        .rule-list li { margin-bottom: 2px; }

        input {
            width: 100%; padding: 12px; font-size: 16px; border: 1px solid var(--border);
            border-radius: 10px; outline: none; text-align: center; margin-bottom: 20px;
            background: #fbfbfd;
        }
        input:focus { border-color: var(--accent); background: #fff; }

        .btn {
            border: none; padding: 14px; border-radius: 12px; font-size: 16px; font-weight: 600;
            cursor: pointer; width: 100%; transition: opacity 0.2s, transform 0.1s;
        }
        .btn:active { transform: scale(0.98); opacity: 0.8; }
        .btn-primary { background: var(--text); color: #fff; }
        
        .mode-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-opt {
            flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 10px;
            text-align: center; cursor: pointer; transition: 0.2s;
        }
        .mode-opt.selected { border-color: var(--accent); background: #f0f8ff; color: var(--accent); font-weight: 600; }
        .mode-desc { font-size: 10px; color: var(--sub-text); margin-top: 2px; }

        /* Game Header - „Ç≥„É≥„Éë„ÇØ„ÉàÂåñ */
        .header { 
            display: flex; justify-content: space-between; align-items: flex-end; 
            padding-bottom: 8px; border-bottom: 1px solid #f5f5f7; margin-bottom: 10px; flex-shrink: 0;
        }
        .stat-val { font-size: 18px; font-weight: 700; font-variant-numeric: tabular-nums; }
        .badge-area { font-size: 10px; font-weight: 700; height: 14px; display: flex; gap: 4px; justify-content: flex-end;}
        .pen-badge { color: var(--danger); display: none; }
        .bonus-badge { color: var(--success); display: none; }
        .show { display: inline; animation: flash 1s; }

        /* Formula Area */
        .formula-container { margin-bottom: 10px; position: relative; flex-shrink: 0; }
        .formula-box {
            height: 50px; background: #f5f5f7; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: 500;
            border: 2px solid transparent; overflow: hidden; white-space: nowrap; transition: 0.3s;
        }
        .formula-box.error { border-color: var(--danger); color: var(--danger); }
        .formula-box.success { border-color: var(--success); color: var(--success); background: #eaffef; }
        .formula-box.prime-active { border-color: var(--prime); background: #fcf5ff; color: var(--prime); }
        .formula-box.prime-active.success { background: #fcf5ff; color: var(--prime); border-color: var(--prime); }

        .prime-info { display: flex; justify-content: flex-end; font-size: 10px; color: var(--sub-text); margin-top: 2px; padding-right: 4px; }

        /* Field - È´ò„ÅïË™øÊï¥ */
        .field {
            display: flex; flex-wrap: wrap; gap: 6px; justify-content: center;
            align-content: flex-start; margin-bottom: auto; 
            overflow-y: auto; /* „Ç´„Éº„Éâ„ÅåÂ§ö„ÅÑÂ†¥Âêà„Å´„Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Å´ */
            padding-bottom: 10px;
            flex-grow: 1; /* ÊÆã„Çä„ÅÆ„Çπ„Éö„Éº„Çπ„ÇíÂüã„ÇÅ„Çã */
        }
        .card {
            background: #fff; border: 1px solid var(--border); border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: 600; cursor: pointer;
            width: calc(20% - 6px); aspect-ratio: 0.85;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative;
        }
        .field.hard .card { width: calc(14.2% - 6px); font-size: 16px; }
        .card.selected { background: var(--text); color: #fff; border-color: var(--text); transform: translateY(-2px); }
        .card.empty { visibility: hidden; pointer-events: none; }

        /* Controls - Âõ∫ÂÆöÈ´ò„ÅïÁ¢∫‰øù */
        .controls { background: #f5f5f7; border-radius: 16px; padding: 10px; flex-shrink: 0; }
        .sub-actions { display: flex; gap: 8px; margin-bottom: 8px; }
        .btn-sub {
            flex: 1; padding: 8px; font-size: 11px; font-weight: 600; border-radius: 8px;
            border: 1px solid #e5e5ea; background: #fff; color: var(--sub-text); cursor: pointer;
        }

        .keypad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
        .key.hard-only { display: none; }
        .keypad.hard-mode .key.hard-only { display: flex; background: #fff5f5; color: #d63384; }
        
        .key {
            height: 40px; background: #fff; border: 1px solid #e5e5ea; border-radius: 8px;
            font-size: 15px; cursor: pointer; color: var(--text); display: flex; align-items: center; justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        .key:active { background: #e5e5ea; }
        .key.op { color: var(--accent); font-weight: 600; }
        .key.func { font-size: 10px; font-weight: 700; color: var(--sub-text); }
        .key.enter { grid-column: span 3; background: var(--accent); color: #fff; border: none; font-weight: 600; }
        .key.prime { grid-column: span 2; background: var(--prime); color: #fff; border: none; font-weight: 600; font-size: 13px; }
        .key.del { color: var(--danger); }

        .rank-list {
            margin-top: 20px; border: 1px solid #e5e5ea; border-radius: 12px; overflow: hidden;
            max-height: 40vh; overflow-y: auto; background: #fff; flex: 1;
        }
        .rank-row { display: flex; align-items: center; padding: 10px 14px; border-bottom: 1px solid #f5f5f7; font-size: 13px; }
        .rank-row:last-child { border-bottom: none; }
        .rank-left { display: flex; align-items: center; flex: 1; overflow: hidden; margin-right: 10px; }
        .rank-right { font-weight: 700; white-space: nowrap; }
        .rank-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        
        .rank-1, .rank-2, .rank-3 { font-weight: 600; }
        .rank-1 { background-color: #fffae6; }
        .rank-2 { background-color: #f8f8f8; }
        .rank-3 { background-color: #fff4e6; }
        .rank-icon { display: inline-block; width: 18px; text-align: center; margin-right: 6px; flex-shrink: 0; }
        .rank-num { color: var(--sub-text); font-weight: 600; }

        .badge { padding: 2px 5px; border-radius: 4px; font-size: 9px; font-weight: 700; margin-right: 6px; flex-shrink: 0; }
        .badge-easy { background: #e3f2fd; color: var(--accent); }
        .badge-hard { background: #ffebee; color: var(--danger); }
        
        .res-info { display: flex; justify-content: space-between; width: 100%; border-bottom: 1px solid #e5e5ea; padding-bottom: 10px; margin-bottom: 10px; }
        
        @keyframes flash { 0%,100%{opacity:1} 50%{opacity:0} }
    </style>
</head>
<body>

<div id="app">
    <div id="s-login" class="screen active">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
            <h1>Make10 Speed</h1>
            <div class="rule-container">
                <p class="rule-desc">
                    Ë®àÁÆó„Åó„Å¶„Ç´„Éº„Éâ„ÇíÂÖ®„Å¶Ê∂à„Åõ„Å∞„ÇØ„É™„Ç¢„ÄÇ<br>
                    „Äå10„Äç„Åæ„Åü„ÅØ„ÄåÁ¥†Êï∞„Äç„Çí‰Ωú„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                </p>
                <details>
                    <summary>‚ñº Ë©≥Á¥∞„É´„Éº„É´ / „Éö„Éä„É´„ÉÜ„Ç£</summary>
                    <ul class="rule-list">
                        <li><strong>ÁõÆÊ®ô: 10</strong><br>Ë®àÁÆóÁµêÊûú„Åå10„Å´„Å™„Çå„Å∞„Ç´„Éº„Éâ„ÅåÊ∂à„Åà„Åæ„Åô„ÄÇ<br>Â†¥„Å´„ÅÇ„Çã„Ç´„Éº„Éâ„ÇíÂÖ®„Å¶‰∏ÄÂ∫¶„Å´‰Ωø„ÅÜ„Å® <strong>-10Áßí„Éú„Éº„Éä„Çπ</strong>„ÄÇ</li>
                        <li><strong>Á¥†Êï∞„ÉÅ„É£„É¨„É≥„Ç∏</strong><br>„ÄåPRIME !!„Äç„Éú„Çø„É≥„ÅßÂÆüË°å„ÄÇ<br>ÂâçÂõû„Çà„ÇäÂ§ß„Åç„ÅÑÁ¥†Êï∞„Çí‰Ωú„Çã„Å®ÊàêÂäü„ÄÇ<br>Â†±ÈÖ¨: <strong>-5Áßí„Éú„Éº„Éä„Çπ</strong> (10ÂÑÑ‰ª•‰∏ã)</li>
                        <li><strong>PASS („Éë„Çπ)</strong><br>Â†¥„ÅÆ„Ç´„Éº„Éâ„ÇíÂÖ•„ÇåÊõø„Åà„Åæ„Åô„ÄÇ<br>„Éö„Éä„É´„ÉÜ„Ç£: <strong>+5Áßí</strong></li>
                        <li><strong>RETIRE („É™„Çø„Ç§„Ç¢)</strong><br>„Éö„Éä„É´„ÉÜ„Ç£: ÊÆã„ÇäÊûöÊï∞ √ó <strong>12Áßí(Easy)/30Áßí(Hard)</strong></li>
                    </ul>
                </details>
            </div>
            
            <span class="label">PLAYER NAME</span>
            <input type="text" id="username" placeholder="Name" maxlength="10">
            
            <span class="label">MODE SELECT</span>
            <div class="mode-group">
                <div class="mode-opt selected" onclick="app.setMode('easy')" id="m-easy">
                    EASY
                    <div class="mode-desc">0-9 / 20 Cards<br>Basic Math Only</div>
                </div>
                <div class="mode-opt" onclick="app.setMode('hard')" id="m-hard">
                    HARD
                    <div class="mode-desc">1-30 / 50 Cards<br>Full Adv. Math</div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="app.start()">START GAME</button>
        </div>
    </div>

    <div id="s-game" class="screen">
        <div class="header">
            <div>
                <span class="label">REMAINING</span>
                <div class="stat-val" id="deck-disp">0</div>
            </div>
            <div style="text-align:right;">
                <span class="label">TIME</span>
                <div class="stat-val" id="timer">0.00</div>
                <div class="badge-area">
                    <span id="bonus-badge" class="bonus-badge">-5s PRIME!</span>
                    <span id="pen-badge" class="pen-badge">+PENALTY</span>
                </div>
            </div>
        </div>

        <div class="formula-container">
            <div id="formula" class="formula-box"></div>
            <div class="prime-info">Next Prime > <span id="last-prime">0</span></div>
        </div>

        <div id="field" class="field"></div>

        <div class="controls">
            <div class="sub-actions">
                <button class="btn-sub" onclick="game.pass()">PASS (+5s)</button>
                <button class="btn-sub" style="color:var(--danger)" onclick="game.retire()">RETIRE (Give Up)</button>
            </div>
            
            <div id="keypad" class="keypad">
                <button class="key func hard-only" onclick="game.push('^')">XOR</button>
                <button class="key func hard-only" onclick="game.push('&')">AND</button>
                <button class="key func hard-only" onclick="game.push('|')">OR</button>
                <button class="key func hard-only" onclick="game.push('<<')">&lt;&lt;</button>
                <button class="key func hard-only" onclick="game.push('>>')">&gt;&gt;</button>

                <button class="key func" onclick="game.push('Math.sqrt(')">‚àö</button>
                <button class="key func" onclick="game.push('Math.abs(')">ABS</button>
                <button class="key func" onclick="game.push('Math.floor(')">FLR</button>
                <button class="key func hard-only" onclick="game.push('%')">MOD</button>
                <button class="key func hard-only" onclick="game.push('~')">NOT</button>

                <button class="key op" onclick="game.push('+')">+</button>
                <button class="key op" onclick="game.push('-')">&minus;</button>
                <button class="key op" onclick="game.push('*')">&times;</button>
                <button class="key op" onclick="game.push('/')">&divide;</button>
                <button class="key func" onclick="game.push('**')">POW</button>

                <button class="key op" onclick="game.push('(')">(</button>
                <button class="key op" onclick="game.push(')')">)</button>
                <button class="key del" onclick="game.pop()">DEL</button>
                <button class="key" onclick="game.clear()">CLR</button>
                <button class="key" onclick="game.push('.')">.</button>

                <button class="key enter" onclick="game.submit('normal')">ENTER (10)</button>
                <button class="key prime" onclick="game.submit('prime')">PRIME !!</button>
            </div>
        </div>
    </div>

    <div id="s-result" class="screen">
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; padding-top:20px;">
            <h1 id="res-title">FINISHED</h1>
            
            <div class="res-info">
                <div>
                    <span class="label">MODE</span>
                    <div style="font-weight:600;" id="res-mode">EASY</div>
                </div>
                <div style="text-align:right;">
                    <span class="label">FINAL TIME</span>
                    <div style="font-weight:700; font-size:24px; color:var(--accent);" id="res-time">0.00s</div>
                </div>
            </div>

            <div style="width:100%; font-size:12px; color:var(--sub-text); margin-bottom:20px;">
                Penalty: <span id="res-pen" style="color:var(--danger)">0</span>s | 
                Bonus: <span id="res-bonus" style="color:var(--success)">0</span>s
            </div>

            <span class="label" style="width:100%">TOP 7 PLAYERS</span>
            <div id="ranking" class="rank-list">Loading...</div>
            
            <button class="btn btn-primary" style="margin-top:10px;" onclick="location.reload()">PLAY AGAIN</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCrhya7vth8ecxzd7TZA7jQIwYrKsZq7_0",
        authDomain: "make10speed.firebaseapp.com",
        projectId: "make10speed",
        storageBucket: "make10speed.firebasestorage.app",
        messagingSenderId: "422015463278",
        appId: "1:422015463278:web:df7d98641c2adf6d915b7f",
        measurementId: "G-7XLB8CVG6D"
    };
    let db = null;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
    } catch(e) { console.warn("Offline"); }

    const MODES = {
        easy: { deck: 20, field: 5, min: 0, max: 9 },
        hard: { deck: 50, field: 7, min: 1, max: 30 }
    };
    const MAX_PRIME_CHECK = 1000000000; // 1 Billion

    window.app = {
        mode: 'easy',
        setMode(m) {
            this.mode = m;
            document.querySelectorAll('.mode-opt').forEach(el => el.classList.remove('selected'));
            document.getElementById('m-'+m).classList.add('selected');
        },
        start() {
            const u = document.getElementById('username').value.trim() || "Guest";
            game.init(u, this.mode);
        }
    };

    window.game = {
        user: '',
        mode: '',
        conf: {},
        deck: [],
        field: [],
        input: [],
        startTime: 0,
        penTime: 0,
        bonusTime: 0,
        timer: null,
        active: false,
        lastPrime: 0,

        init(user, mode) {
            this.user = user;
            this.mode = mode;
            this.conf = MODES[mode];
            
            this.deck = [];
            const range = this.conf.max - this.conf.min + 1;
            for(let i=0; i<this.conf.deck; i++) {
                this.deck.push(Math.floor(Math.random()*range) + this.conf.min);
            }

            this.field = new Array(this.conf.field).fill(null);
            this.fillField();

            document.getElementById('s-login').classList.remove('active');
            document.getElementById('s-game').classList.add('active');
            
            const fieldEl = document.getElementById('field');
            const keypadEl = document.getElementById('keypad');
            if(mode==='hard') {
                fieldEl.classList.add('hard');
                keypadEl.classList.add('hard-mode');
            } else {
                fieldEl.classList.remove('hard');
                keypadEl.classList.remove('hard-mode');
            }

            this.input = [];
            this.penTime = 0;
            this.bonusTime = 0;
            this.active = true;
            this.startTime = Date.now();
            this.lastPrime = 0;
            document.getElementById('last-prime').innerText = 0;
            
            this.render();
            
            if(this.timer) clearInterval(this.timer);
            this.timer = setInterval(() => {
                if(!this.active) return;
                const now = (Date.now() - this.startTime)/1000;
                let total = now + this.penTime - this.bonusTime;
                if(total < 0) total = 0;
                document.getElementById('timer').innerText = total.toFixed(2);
                
                if(this.penTime > 0) document.getElementById('pen-badge').style.display = 'inline';
                if(this.bonusTime > 0) document.getElementById('bonus-badge').style.display = 'inline';
            }, 50);
        },

        fillField() {
            const range = this.conf.max - this.conf.min + 1;
            for(let i=0; i<this.field.length; i++) {
                if(!this.field[i]) {
                    if(this.deck.length > 0) {
                        this.field[i] = {
                            id: Math.random().toString(36),
                            val: this.deck.pop()
                        };
                    }
                }
            }
        },

        render() {
            document.getElementById('deck-disp').innerText = this.deck.length;
            const fBox = document.getElementById('formula');
            fBox.innerText = this.input.map(i => i.val).join(' ');
            fBox.className = 'formula-box';

            const container = document.getElementById('field');
            container.innerHTML = '';
            this.field.forEach((c, idx) => {
                const el = document.createElement('div');
                if(!c) {
                    el.className = 'card empty';
                } else {
                    el.className = 'card';
                    el.innerText = c.val;
                    if(this.input.some(i => i.refId === c.id)) el.classList.add('selected');
                    el.onclick = () => this.tap(idx);
                }
                container.appendChild(el);
            });
        },

        tap(idx) {
            if(!this.active) return;
            const c = this.field[idx];
            if(!c || this.input.some(i => i.refId === c.id)) return;
            this.input.push({ type:'num', val:c.val, refId:c.id });
            this.render();
        },

        push(v) { if(this.active) { this.input.push({ type:'op', val:v }); this.render(); } },
        pop() { if(this.active) { this.input.pop(); this.render(); } },
        clear() { if(this.active) { this.input = []; this.render(); } },

        isPrimeCheck(n) {
            if(n > MAX_PRIME_CHECK) return false;
            if (n < 2 || !Number.isInteger(n)) return false;
            if (n === 2) return true;
            if (n % 2 === 0) return false;
            const limit = Math.sqrt(n);
            for (let i = 3; i <= limit; i += 2) {
                if (n % i === 0) return false;
            }
            return true;
        },

        submit(type) {
            if(!this.active || this.input.length===0) return;
            const expr = this.input.map(i => i.val).join('');
            try {
                if(/[^0-9+\-*/().Mathsqrtfloorabs%&|^~<>\s]/g.test(expr)) throw new Error("Inv");
                const res = Function('"use strict";return (' + expr + ')')();
                
                if(res > MAX_PRIME_CHECK) throw new Error("Too Big");

                if(type === 'prime') {
                    if(this.isPrimeCheck(res) && res > this.lastPrime) {
                        this.successPrime(res);
                    } else {
                        this.fail();
                    }
                } else {
                    if(Math.abs(res - 10) < 0.00001) {
                        this.success();
                    } else {
                        this.fail();
                    }
                }
            } catch(e) { this.fail(); }
        },

        success() {
            this.flashSuccess('success', "-10s BONUS!");
            this.processSuccess(0);
        },

        successPrime(newPrime) {
            this.lastPrime = newPrime;
            document.getElementById('last-prime').innerText = newPrime;
            this.flashSuccess('prime-active', "-5s PRIME!");
            this.processSuccess(5);
        },
        
        flashSuccess(cls, msg) {
            const fb = document.getElementById('formula');
            fb.classList.add(cls);
            if(cls === 'prime-active') fb.classList.add('success');
            
            const badge = document.getElementById('bonus-badge');
            badge.innerText = msg;
            badge.classList.remove('show');
            void badge.offsetWidth;
            badge.classList.add('show');
        },

        processSuccess(baseBonus) {
            const usedIds = this.input.filter(i => i.type==='num').map(i=>i.refId);
            const activeCardsCount = this.field.filter(x => x !== null).length;
            
            let totalBonus = baseBonus;
            if (usedIds.length === activeCardsCount && usedIds.length > 1) {
                totalBonus += 10;
                const badge = document.getElementById('bonus-badge');
                badge.innerText = "PERFECT! -" + totalBonus + "s";
                badge.classList.remove('show');
                void badge.offsetWidth;
                badge.classList.add('show');
            }
            
            this.bonusTime += totalBonus;

            for(let i=0; i<this.field.length; i++) {
                if(this.field[i] && usedIds.includes(this.field[i].id)) this.field[i] = null;
            }
            this.fillField();
            this.input = [];
            
            const rem = this.deck.length + this.field.filter(x=>x).length;
            if(rem === 0) this.finish("FINISHED");
            else setTimeout(() => this.render(), 100);
        },

        fail() {
            const el = document.getElementById('formula');
            el.classList.add('error');
            setTimeout(() => el.classList.remove('error'), 300);
        },

        pass() {
            if(!this.active || !confirm("PASS? (+5s Penalty)")) return;
            this.penTime += 5;
            const range = this.conf.max - this.conf.min + 1;
            for(let i=0; i<this.field.length; i++) {
                if(this.field[i]) {
                    this.field[i].val = Math.floor(Math.random()*range) + this.conf.min;
                    this.field[i].id = Math.random().toString(36);
                }
            }
            this.input = [];
            this.render();
            
            const pBadge = document.getElementById('pen-badge');
            pBadge.style.display = 'inline';
            pBadge.classList.remove('show');
            void pBadge.offsetWidth;
            pBadge.classList.add('show');
        },

        retire() {
            if(!this.active || !confirm("Give up?")) return;
            const rem = this.deck.length + this.field.filter(x=>x).length;
            const penPerCard = this.mode === 'hard' ? 30 : 12;
            this.penTime += (rem * penPerCard);
            this.finish("RETIRED");
        },

        finish(status) {
            this.active = false;
            clearInterval(this.timer);
            const timeRaw = (Date.now() - this.startTime)/1000;
            let finalTime = timeRaw + this.penTime - this.bonusTime;
            if(finalTime < 0) finalTime = 0;

            document.getElementById('s-game').classList.remove('active');
            document.getElementById('s-result').classList.add('active');
            
            document.getElementById('res-title').innerText = status;
            document.getElementById('res-time').innerText = finalTime.toFixed(2) + 's';
            document.getElementById('res-mode').innerText = this.mode.toUpperCase();
            document.getElementById('res-pen').innerText = this.penTime;
            document.getElementById('res-bonus').innerText = this.bonusTime;
            
            if(db) {
                db.collection("make10_scores_final").add({
                    name: this.user,
                    mode: this.mode,
                    time: finalTime,
                    date: new Date()
                }).then(() => this.loadRanking());
            } else {
                document.getElementById('ranking').innerText = "Offline Mode";
            }
        },

        loadRanking() {
            if(!db) return;
            db.collection("make10_scores_final").orderBy("time", "asc").limit(7).get().then(snap => {
                let html = '';
                let rank = 1;
                snap.forEach(doc => {
                    const d = doc.data();
                    const badgeClass = d.mode === 'hard' ? 'badge-hard' : 'badge-easy';
                    const modeLabel = d.mode === 'hard' ? 'H' : 'E';
                    
                    let rankClass = '';
                    let icon = '';
                    if(rank === 1) { rankClass = 'rank-1'; icon = 'ü•á'; }
                    else if(rank === 2) { rankClass = 'rank-2'; icon = 'ü•à'; }
                    else if(rank === 3) { rankClass = 'rank-3'; icon = 'ü•â'; }
                    else { icon = `<span class="rank-num">${rank}</span>`; }

                    html += `
                    <div class="rank-row ${rankClass}">
                        <div class="rank-left">
                            <span class="rank-icon">${icon}</span>
                            <span class="badge ${badgeClass}">${modeLabel}</span>
                            <span class="rank-name">${d.name}</span>
                        </div>
                        <div class="rank-right">${d.time.toFixed(2)}s</div>
                    </div>`;
                    rank++;
                });
                document.getElementById('ranking').innerHTML = html;
            });
        }
    };
</script>
</body>
</html>
